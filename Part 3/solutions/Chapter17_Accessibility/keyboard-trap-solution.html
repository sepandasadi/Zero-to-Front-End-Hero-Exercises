<!doctype html>
<meta charset="utf-8"/>
<title>Keyboard Trap (Fixed)</title>
<style>
  .modal { position: fixed; inset: 10% 20%; background: #fff; border: 1px solid #ccc; padding: 1rem; }
  .backdrop { position: fixed; inset: 0; background: rgba(0,0,0,.5); }
  :focus-visible { outline: 3px solid #000; outline-offset: 2px; }
</style>
<button id="open">Open modal</button>
<div id="backdrop" class="backdrop" hidden></div>
<div id="modal" class="modal" hidden role="dialog" aria-modal="true" aria-labelledby="title">
  <h2 id="title">Example Modal</h2>
  <input placeholder="Your name">
  <a href="#">Focusable link</a>
  <button id="close">Close</button>
</div>
<script>
  const openBtn = document.getElementById('open')
  const closeBtn = document.getElementById('close')
  const modal = document.getElementById('modal')
  const backdrop = document.getElementById('backdrop')
  let lastFocus = null
  function getTrapElements(root){
    return [...root.querySelectorAll('a[href], button, input, select, textarea, [tabindex]:not([tabindex="-1"])')].filter(el=>!el.hasAttribute('disabled') && !el.getAttribute('aria-hidden'))
  }
  function open(){
    lastFocus = document.activeElement
    modal.hidden = false; backdrop.hidden = false
    const els = getTrapElements(modal); els[0]?.focus()
  }
  function close(){
    modal.hidden = true; backdrop.hidden = true
    lastFocus?.focus()
  }
  openBtn.addEventListener('click', open)
  closeBtn.addEventListener('click', close)
  document.addEventListener('keydown', (e) => {
    if (modal.hidden) return
    if (e.key === 'Escape') { e.preventDefault(); close() }
    if (e.key === 'Tab') {
      const els = getTrapElements(modal)
      const first = els[0], last = els[els.length-1]
      if (e.shiftKey && document.activeElement === first) { e.preventDefault(); last.focus() }
      else if (!e.shiftKey && document.activeElement === last) { e.preventDefault(); first.focus() }
    }
  })
</script>
